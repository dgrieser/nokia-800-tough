'use strict';var oncetime=0;navigator.mozSetMessageHandler('activity',function(activity){oncetime=oncetime+1;if(oncetime!==1){return;}
var tonePlayer=new TonePlayer();var toneTypes=activity.source.data.type;var allowNone=activity.source.data.allowNone;var currentToneID=activity.source.data.currentToneID;var allToneTypes=window.builtInRingtones.toneTypes;if(!Array.isArray(toneTypes)){toneTypes=[toneTypes];}
toneTypes=toneTypes.filter(function(x){return allToneTypes.indexOf(x)!==-1;});window.addEventListener('keydown',function(e){if(e.key==='Backspace'){tonePlayer.stop();activity.postError('cancelled');e.preventDefault();}});window.addEventListener('visibilitychange',function(){if((!document.hidden)&&(!document.querySelector('.group-menu'))){var evt=new CustomEvent('listReady',{detail:{restoreFocus:true,ringtoneVisibilityChange:true}});window.dispatchEvent(evt);}});window.addEventListener('largetextenabledchanged',function(){document.body.classList.toggle('large-text',navigator.largeTextEnabled);});document.body.classList.toggle('large-text',navigator.largeTextEnabled);function PickerToneList(...args){ToneList.apply(this,args);}
PickerToneList.prototype=Object.create(ToneList.prototype);PickerToneList.prototype.constructor=PickerToneList;PickerToneList.prototype.makeItem=function(tone){var item=ToneList.prototype.makeItem.call(this,tone);var input=item.querySelector('input');input.checked=(tone.id===currentToneID);if(item){item.addEventListener('focus',function(){tonePlayer.setTone(tone);});}
return item;};navigator.mozL10n.once(function(){var promises=[];var listParent=document.getElementById('list-parent');var headerTitle=document.getElementById('header-title');headerTitle.innerHTML=navigator.mozL10n.get('section-header-title-'+toneTypes[0]);function addToneLists(toneType,includeNone){var builtInList=new PickerToneList('section-title-builtin-'+toneType,listParent);promises.push(window.builtInRingtones.list(toneType).then(function(tones){builtInList.add(tones);if(includeNone){builtInList.add(new NullRingtone());}}));if(toneType==='alerttone'){document.getElementById('subheader').hidden=true;}
var customList=new PickerToneList('section-title-custom-'+toneType,listParent);promises.push(window.customRingtones.list(toneType).then(function(tones){customList.add(tones);}));}
toneTypes.forEach(function(toneType,i){addToneLists(toneType,i===0&&allowNone);});Promise.all(promises).then(function(listsData){document.querySelector('body').dataset.ready=true;createOptions();window.dispatchEvent(new Event('listReady'));});});function saveTone(){tonePlayer.stop();tonePlayer.isValid(function(valid){if(!valid){activity.postError('cancelled');}
var selectedTone=tonePlayer.currentTone;selectedTone.getBlob().then(function(blob){activity.postResult({name:selectedTone.name,filename:selectedTone.filename,l10nID:selectedTone.l10nID,id:selectedTone.id,blob:blob});});});}
function createOptions(){var params={menuClassName:'menu-button',header:{l10nId:'message'},items:[{name:'Cancel',l10nId:'cancel',priority:1,method:function(){tonePlayer.stop();activity.postError('cancelled');}},{name:'Select',l10nId:'select',priority:2,method:saveTone}]};var option=new SoftkeyPanel(params);option.show();}});